package datalog

import (
	"fmt"
	"sync"
	"time"
)

var IsEventSig sync.Map
var StartTime time.Time

var VyperSig string
var DebugTx string

//var ContractWaitCounter map[int]int
//var ContractCheckFlag map[string]struct{}

func InitDatalog() {
	/*ContractCheckFlag = make(map[string]struct{},700000)
	ContractWaitCounter = make(map[int]int,70000)*/
	fmt.Println("Datalog Init!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
	CountResult.InitCounter()
	InitEventSigMap()

	OyenteResultsDb = initLevelDb(OyenteResultsDbPath)
	ContractToTxDb = initLevelDb(ContractToTxDbPath)
	// TxToContractDb = initLevelDb(txToContractDbPath)
	// newPatternDb = initLevelDb(newPatternDbPath)
	readResultsFromDb(&OyenteResults, OyenteResultsDb, 1)
	readResultsFromDb(&ContractToTxHash, ContractToTxDb, 0)
	// readResultsFromDb(&TxToContract, TxToContractDb)
	VyperSig = "600035601c52740100000000000000000000000000000000000000006020526f7fffffffffffffffffffffffffffffff6040527fffffffffffffffffffffffffffffffff8000000000000000000000000000000060605274012a05f1fffffffffffffffffffffffffdabf41c006080527ffffffffffffffffffffffffed5fa0e000000000000000000000000000000000060a052"
	DebugTx = ""

	StartOyente()

}

func InitEventSigMap() {
	sig_Transfer_arr := []string{
		"0xf0cd1a5c0ee7db84a3a9327b544161b199d1a1088d6dd1c99d42646432eaf9fb",
		"0x8b0c34a52f9e28d78caaa7066cd047b398dae74941a208b77777420f492bd7e1",
		"0x7344fa9abcab6b3790a118567725311a6bfb30957589e825e4300bce8f3fb020",
		"0xd0966ead8911bd02ec5119ed64d10236cb4fd8f29c5001afb73d60689cf88b20",
		"0x8d1591cfd32ad19c215c6295623aea4eec85442fc5c4601cda6f7e0a038186ba",
		"0xb659f7922125405e40eb1a5fbfd9879f3d296b8200019be90f730b459f9f1c25",
		"0x9ce147531995c591b0b50012b20f7f6d0dea75281159a58b8637542388f14626",
		"0x18b3a374e2313c602fb9e4002182a9b948dff0294feab6f98f5e7e4334ef7e9d",
		"0xa88a4735393a2bbb1c23c083874e1d0636d3e87851b6f20a6d2115f5ea540ba0",
		"0xfe28b6744e16875301806797283f9bcc1a29b15f700c0e088645e2c257eec1e5",
		"0xbc87650eb8e9c481db3f2576aea1b4e653894d93b7f6cb6a190717a1fca3a319",
		"0x1306f300bdf23ef00b1fe00644eee04b9576ad8c68837bffa5158e4693ea296a",
		"0xb18cf775c754b8fae1157af9b1f2b93496f6bf0cd582c24d7175692fcaa1cd21",
		"0x354cd84171949f23d6c7393b4deca6b9670954625ffedcb35a250a15a08515ed",
		"0xd6e7a41c23f4209ee7bed2dbe1d4774884aaf836b11d0c93a84b8eb44878dbd3",
		"0x48c4fa90124ada7723a851f5a30fc80851bbfab1f12649e3ae71a32c627720cd",
		"0xcef55929759435389feb62e3ad30d90911d061d3eb8f8e3ead60622531745cc1",
		"0x3fb8d49d89b30c4ee5141c3d10e5bb70e95d5babd584e3000107d2dac22a826a",
		"0x91925c49b49f6ee4ac0d966d8d2e700e489f031bf933396b5b64bc584529d229",
		"0x831ac82b07fb396dafef0077cea6e002235d88e63f35cbd5df2c065107f1e74a",
		"0xe8032327ba5bd636272f39d92559de88e80732a9d637d0b6752d51281150d4b7",
		"0xb7ac3c4762d5a753158c22506d7f1a1373c52dae6059cc91115338581b05e27c",
		"0xcbab2a67020e790d89db09e426191c44c8c05d9f93dc1f8cc32dda14929f40e5",
		"0x1c232f833daad9ed1224c5770c053a18edfef5d85918dede55acc1da05ab6c8b",
		"0x0ed1306281e9b4c9d018e1291d83fd014895d20c95da608569e7d9a5361117aa",
		"0xe670604a3a027fa22059b623a5b0ae38424829237d769b02282dc7d81fb06426",
		"0x81031c58ed866f2ba7f5ac8c702cedc31ed6b4a08cd1d540c988018b0ca5b845",
		"0xfdb0d9db4fcfa99a69bab4019cf42ab495be117bb60275b901645c28ca3deef4",
		"0x1315fe0300efd5bde69c874d107401124940c3cdb534666230a2436a47e6a49b",
		"0x89896edbd223c9360ce42ddfed7522a2bffb20c056e4c42d42370cb493b65676",
		"0x7f02f13368f9b374a15f81ad02096044b4c26fa5127a1fa37aeed8e392bd6edd",
		"0xe86307cdc23d5574d14f14c07d08814d980276c4b92d6d51e6f6497a807607c8",
		"0x8695741cd0cb852f381bcfad35ffa6af9b0f4d1634247d0b2589ad84233dc590",
		"0xc2ac9a11e79ddfc35c6403b568c9d85957090c8416d338be90299141f1e7f425",
		"0x6e348e9e7927772dff9da0764845053058a54199928284bfe6decb7ac09d40d7",
		"0x7c11167a36b8ef38fc546598e268c0964bb2cb21377e6cb80e217bcb6ecb8c67",
		"0x19b40000025b47ecd4d2940168402cfe9317418307f848216988dc028e628214",
		"0xa87ac4316a9088110eb185cf27691b5533890444b36f2712b700fe09a5e53ba7",
		"0xfcdacb06893591fedb6582b761d2e964d37a4e7f77a844e3a05c5fbf47797c0e",
		"0xcf73f4a4f977af3327646216f7d3af8970de9bc70aeaf76009cec99dcf46c786",
		"0x96a6ed04a9960ed29f91a03141a1256a7e6204eb90c319d76a91ec4aa02bbc2f",
		"0x27772adc63db07aae765b71eb2b533064fa781bd57457e1b138592d8198d0959",
		"0xa0f2d9d810b7227d93b1d65511f1321d5331a7a323e6d357130dda4aa99690a0",
		"0x46518209995f34a01926b792690bc92e5037b070563bfdacd84fafd40b513eb5",
		"0xba7196a4bdbfed2416fed23830b5c875c6e32d81744212e9776f7d2b02a33188",
		"0x467c5dc3035b08b8eda1206c6049fd8eb86db17119be0ca51d0de6f99bf7f548",
		"0x0daf680c3f528a8760b5142fe1f6f80d5f4ea18bb76f347a7a44a2d565c2b7dc",
		"0xbae695334f1401f46a8c246fb4e028ccdee498d6cd47ddb5683ab940d25fbdc5",
		"0x2c4d9d1041355b152e80b28195d8cd57a1363203c2b1a39c0559f0e757747d5c",
		"0xcdabd7cd7a44bd50521a39c666b076577c82465c3615f66391d096cc719c6ac0",
		"0xe18706cb56ac477fbc72c6acbbd512822f259c1f09006247dbae41d881bc3e17",
		"0xfd0e41a48c016debc0ec3c87cdf02ba5e2eb2db4587292c6bdcec7bda1fc3d3c",
		"0xa099bc2413531106e46903e9bd7f34d43b6d124631398348d1d5f368baeb8032",
		"0xbff91d4903077cc645099227f3ff63fa8f7c4e51de89afbefde6b29eb549af87",
		"0xe64efe620012ecf67a6a08208071cfd55ea85c641860fa711388c041c80d72f6",
		"0xb76456965aa890ee11746d3b26582281ffca539801841abe6282ab73b2c01993",
		"0xdf5c409937706803ae64d124b48586638c7b50733b40fb16cff8141ffa1e0af8",
		"0x2c5825beae12151d954009ae7f95e998300458d351c8fc8e6d2df9a8753d65a7",
		"0x4c3f23e06500a14887485511327c0d579fbccac302d5839c043bcc62bf867793",
		"0x4ec3ba770fb8428f5ce8590bc4b28663359570e0193206f9364399c06e768241",
		"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
		"0x303dc7e5a79ee0ca02c3f06db0502fbfe7a964cd8fa597919e4376f6dbc1e157",
		"0xf238e8301c28c0dac41fcc9bd2e2d659096a02384c2ffd9b1430ac584c95691e",
		"0x74c9ae5ff92efee44f316c09cbdbdebb254705f4fd59514ed2d87e1e3da93913",
	}

	for _, sig := range sig_Transfer_arr {
		IsEventSig.Store(sig, true)
	}
}

func IsTranferEventSig(sig string) bool {
	if re, ok := IsEventSig.Load(sig); ok && re.(bool) {
		return true
	} else {
		return false
	}
}
